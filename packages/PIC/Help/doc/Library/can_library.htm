
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>

<head>

<title>CAN Library</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="Copyright" content="mikroElektronika 2005.">
<meta name="Author" content="Nikola Topalovic. mailto:office@mikroelektronika.co.yu">

<link rel="stylesheet" type="text/css" href="css/help_c_PIC.css">
<script defer type="text/javascript" src="css/pngfix.js"></script>


	






<link rel="stylesheet" type="text/css" href="css/print.css" media="print">


<style type="text/css">
#top {
  background:transparent url(template/background_PIC.png); 
}

.title{
	PADDING-RIGHT: 2px; 
	PADDING-LEFT: 70px; 
	FONT-WEIGHT: bold; 
	FONT-SIZE: 14px; 
	PADDING-BOTTOM: 3px; 
	PADDING-TOP: 0px; 
	FONT-FAMILY: Verdana;
  color:white;
}

.navigation{
                     PADDING-TOP: -5px;
	PADDING-RIGHT: 2px; 
	PADDING-LEFT: 63px; 
	FONT-SIZE: 11px; 
	FONT-FAMILY: Verdana;
                     color:white;
}

.navigation a:link {text-decoration: none; color: white;}
.navigation a:visited {text-decoration: none; color: white;}
.navigation a:active {text-decoration: none; color: white;}
.navigation a:hover {text-decoration: none; color: white; background:black;}

.nav_bar {
}

#top td p,td pre {
	margin:0 0 0 0;
}
</style>

<style type="text/css" media="screen">
#main{
	border-top: 1px solid #000000;
  padding-left: 15px;
  padding-right: 15px;
	position: absolute;
	top: 59px;
	right: 0px;
	bottom: 0px;
	left: 0px;

	width: expression(document.body.offsetWidth - 3);
	height: expression(document.body.offsetHeight -  65);
	overflow: auto;
}
</style>

</head>


<body>

<div id="top">
<table height="60" width="100%">
  <tbody>
	  <tr>
		  <td>
			  <pre class="nav_bar"><div class="title">CAN Library</div><div class="navigation">&nbsp;&nbsp;<A href="index.htm">mikroC PRO for PIC Libraries</A> &gt; <A href="mikroC_PRO_hardware_libraries.htm">Hardware Libraries</A> &gt; </div></pre>
			</td>
		  <td style="WIDTH: 120px" align="right">
			  <pre class="nav_bar"><A href="adc_library.htm" title="Previous"><img src="template\btn_prev_n.png" border="0"></a>&nbsp;<A title="Top of the Page" href="#top_of_page" alt="Top of the Page"><IMG src="template/btn_up_n.png" border=0 ></a>&nbsp;<A href="canspi_library.htm" title="Next"><img src="template\btn_next_n.png" border="0"></a></pre>
			</td>
		</tr>
	</tbody>
</table>
</div>

	


  <div id="main">

    <a name="top_of_page"><h2><acronym title="Controller Area Network">CAN</acronym> Library</h2></a>


    <p>The mikroC PRO for PIC provides a library (driver) for working with the <acronym title="Controller Area Network">CAN</acronym> module.</p>
    <p>The <acronym title="Controller Area Network">CAN</acronym> is a very robust protocol that has error detection and signalization, selfâ€“checking and fault confinement. Faulty <acronym title="Controller Area Network">CAN</acronym> data and remote frames are re-transmitted automatically, similar to the Ethernet.</p>
    <p> Data transfer rates depends on the distance. For example, 1 Mbit/s can be achieved at network lengths below 40m while 250 Kbit/s can be achieved at network lengths below 250m. The greater distance the lower maximum bitrate that can be achieved. The lowest bitrate defined by the standard is 200Kbit/s. Cables used are shielded twisted pairs.</p>
    <p><acronym title="Controller Area Network">CAN</acronym> supports two message formats:</p>
    <ul>
      <li>Standard format, with 11 identifier bits, and</li>
      <li>Extended format, with 29 identifier bits</li>
    </ul>
    
    <div style="border: 1.00pt solid #cccccc; padding: 5.00pt; background: #f5f2ec">	  
      <img src="img/note.gif" align="absmiddle"><b>&nbsp;&nbsp;Important :</b>
      <ul>
        <li>Consult the <acronym title="Controller Area Network">CAN</acronym> standard about <acronym title="Controller Area Network">CAN</acronym> bus termination resistance.</li>   
      	<li>When using MCUs with remappable pins, make sure that <a href="peripheral_pin_select_library.htm">Peripheral Pin Select Library</a> is checked in the <a href="library_manager.htm">Library Manager</a> and that appropriate pins were mapped.</li>        
      </ul>
    </div>

    <!-- -->

    <p></p>
    <h3>Library Routines</h3>

    <ul>
      <li><a href="#cansetoperationmode">CANSetOperationMode</a></li>
      <li><a href="#cangetoperationmode">CANGetOperationMode</a></li>
      <li><a href="#caninitialize">CANInitialize</a></li>
      <li><a href="#caninitialize_remappable">CANInitialize_Remappable</a></li>
      <li><a href="#cansetbaudrate">CANSetBaudRate</a></li>
      <li><a href="#cansetmask">CANSetMask</a></li>
      <li><a href="#cansetfilter">CANSetFilter</a></li>
      <li><a href="#canread">CANRead</a></li>
      <li><a href="#canwrite">CANWrite</a></li>
      <li><a href="#cansettxidlelevel">CANSetTxIdleLevel</a></li>
    </ul>
    

    <!-- -->


    <h3 id="cansetoperationmode">CANSetOperationMode</h3>


    <!-- tabela: CANSetOperationMode -->

    <table class="routine" width="100%">

      <!--
      <caption></caption>

      <thead></thead>
      -->

      <tbody>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th width="0" valign="top">Prototype</th>
          <td class="code" width="100%" valign="top">
            <p><b>void</b> CANSetOperationMode(<b>unsigned short</b> mode, <b>unsigned short</b> wait_flag);</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Returns</th>
          <td valign="top">
            <p>Nothing.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Description</th>
          <td valign="top">
            <p>Sets <acronym title="Controller Area Network">CAN</acronym> to requested mode, i.e. copies <code>mode</code> to CANSTAT. Parameter <code>mode</code> needs to be one of <code>CAN_OP_MODE</code> constants (see <a href="#can_constants">CAN constants</a>).</p>
            <p>Parameter <code>wait_flag</code> needs to be either 0 or 0xFF:</p>
            <ul>
              <li>If set to 0xFF, this is a blocking call &#8211; the function won&#8217;t &#8220;return&#8221; until the requested mode is set.</li>
              <li>If 0, this is a non-blocking call. It does not verify if CAN module is switched to requested mode or not. Caller must use <code>CANGetOperationMode</code> to verify correct operation mode before performing mode specific operation.</li>
            </ul>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Requires</th>
          <td valign="top">
            <p>Microcontroller must be connected to <acronym title="Controller Area Network">CAN</acronym> transceiver (MCP2551 or similar) which is connected to <acronym title="Controller Area Network">CAN</acronym> bus.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Example</th>
          <td valign="top">

<pre>
CANSetOperationMode(_CAN_MODE_CONFIG, 0xFF);</pre>

          </td>
        </tr>

      </tbody>

    </table>

    <!-- kraj tabele -->


    <!-- -->


    <h3 id="cangetoperationmode">CANGetOperationMode</h3>


    <!-- tabela: CANGetOperationMode -->

    <table class="routine" width="100%">

      <!--
      <caption></caption>

      <thead></thead>
      -->

      <tbody>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th width="0" valign="top">Prototype</th>
          <td class="code" width="100%" valign="top">
            <p><b>unsigned short</b> CANGetOperationMode();</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Returns</th>
          <td valign="top">
            <p>Current opmode.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Description</th>
          <td valign="top">
            <p>Function returns current operational mode of <acronym title="Controller Area Network">CAN</acronym> module.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Requires</th>
          <td valign="top">
            <p>Microcontroller must be connected to <acronym title="Controller Area Network">CAN</acronym> transceiver (MCP2551 or similar) which is connected to <acronym title="Controller Area Network">CAN</acronym> bus.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Example</th>
          <td valign="top">

<pre>
<b>if</b> (CANGetOperationMode() == _CAN_MODE_NORMAL) { ... };</pre>

          </td>
        </tr>

      </tbody>

    </table>

    <!-- kraj tabele -->

    <!-- -->

    <h3 id="caninitialize">CANInitialize</h3>


    <!-- tabela: CANInitialize -->

    <table class="routine" width="100%">

      <!--
      <caption></caption>

      <thead></thead>
      -->

      <tbody>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th width="0" valign="top">Prototype</th>
          <td class="code" width="100%" valign="top">
            <p><b>void</b> CANInitialize(<b>char</b> SJW, <b>char</b> BRP, <b>char</b> PHSEG1, <b>char</b> PHSEG2, <b>char</b> PROPSEG, <b>char</b> CAN_CONFIG_FLAGS);</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Returns</th>
          <td valign="top">
            <p>Nothing.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Description</th>
          <td valign="top">
            <p>Initializes <acronym title="Controller Area Network">CAN</acronym>. All pending transmissions are aborted. Sets all mask registers to 0 to allow all messages.</p>
            <p>Filter registers are set according to flag value:</p>
<pre>
<b>if</b> (CAN_CONFIG_FLAGS &#38; _CAN_CONFIG_VALID_XTD_MSG != 0)
  <i>// Set all filters to XTD_MSG</i>
<b>else if</b> (config &#38; _CAN_CONFIG_VALID_STD_MSG != 0)
  <i>// Set all filters to STD_MSG</i>
<b>else</b>
  <i>// Set half of the filters to STD, and the rest to XTD_MSG.</i></pre>

            <p>Parameters:</p>
            <ul>
              <li><code>SJW</code> as defined in datasheet (1&#8211;4)</li>
              <li><code>BRP</code> as defined in datasheet (1&#8211;64)</li>
              <li><code>PHSEG1</code> as defined in datasheet (1&#8211;8)</li>
              <li><code>PHSEG2</code> as defined in datasheet (1&#8211;8)</li>
              <li><code>PROPSEG</code> as defined in datasheet (1&#8211;8)</li>
              <li><code>CAN_CONFIG_FLAGS</code> is formed from predefined constants (see <a href="#can_constants">CAN constants</a>)</li>
            </ul>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Requires</th>
          <td valign="top">
            <p><acronym title="Controller Area Network">CAN</acronym> must be in Config mode; otherwise the function will be ignored.</p>
            <p>Microcontroller must be connected to <acronym title="Controller Area Network">CAN</acronym> transceiver (MCP2551 or similar) which is connected to <acronym title="Controller Area Network">CAN</acronym> bus.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Example</th>
          <td valign="top">

<pre>
init = _CAN_CONFIG_SAMPLE_THRICE &#38;
       _CAN_CONFIG_PHSEG2_PRG_ON &#38;
       _CAN_CONFIG_STD_MSG       &#38;
       _CAN_CONFIG_DBL_BUFFER_ON &#38;
       _CAN_CONFIG_VALID_XTD_MSG &#38;
       _CAN_CONFIG_LINE_FILTER_OFF;
...
CANInitialize(1, 1, 3, 3, 1, init);   <i>// initialize CAN</i></pre>

          </td>
        </tr>

      </tbody>

    </table>

    <!-- kraj tabele -->

    <!-- -->

    <h3 id="caninitialize_remappable">CANInitialize_Remappable</h3>


    <!-- tabela: CANInitialize_Remappable -->

    <table class="routine" width="100%">

      <!--
      <caption></caption>

      <thead></thead>
      -->

      <tbody>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th width="0" valign="top">Prototype</th>
          <td class="code" width="100%" valign="top">
            <p><b>void</b> CANInitialize_Remappable(<b>char</b> SJW, <b>char</b> BRP, <b>char</b> PHSEG1, <b>char</b> PHSEG2, <b>char</b> PROPSEG, <b>char</b> CAN_CONFIG_FLAGS);</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Returns</th>
          <td valign="top">
            <p>Nothing.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Description</th>
          <td valign="top">
            <p>Initializes <acronym title="Controller Area Network">CAN</acronym>. All pending transmissions are aborted. Sets all mask registers to 0 to allow all messages.</p>
            <p>Filter registers are set according to flag value:</p>
<pre>
<b>if</b> (CAN_CONFIG_FLAGS &#38; _CAN_CONFIG_VALID_XTD_MSG != 0)
  <i>// Set all filters to XTD_MSG</i>
<b>else if</b> (config &#38; _CAN_CONFIG_VALID_STD_MSG != 0)
  <i>// Set all filters to STD_MSG</i>
<b>else</b>
  <i>// Set half of the filters to STD, and the rest to XTD_MSG.</i></pre>

            <p>Parameters:</p>
            <ul>
              <li><code>SJW</code> as defined in datasheet (1&#8211;4)</li>
              <li><code>BRP</code> as defined in datasheet (1&#8211;64)</li>
              <li><code>PHSEG1</code> as defined in datasheet (1&#8211;8)</li>
              <li><code>PHSEG2</code> as defined in datasheet (1&#8211;8)</li>
              <li><code>PROPSEG</code> as defined in datasheet (1&#8211;8)</li>
              <li><code>CAN_CONFIG_FLAGS</code> is formed from predefined constants (see <a href="#can_constants">CAN constants</a>)</li>
            </ul>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Requires</th>
          <td valign="top">
            <p><acronym title="Controller Area Network">CAN</acronym> must be in Config mode; otherwise the function will be ignored.</p>
            <p>Microcontroller must be connected to <acronym title="Controller Area Network">CAN</acronym> transceiver (MCP2551 or similar) which is connected to <acronym title="Controller Area Network">CAN</acronym> bus.</p>

            <div style="border: 1.00pt solid #cccccc; padding: 5.00pt; background: #f5f2ec">
              <img src="img/note.gif" align="absmiddle"><b>&nbsp;&nbsp;Note :</b>
                <ul>
                	<li>Before using this library, make sure that <a href="peripheral_pin_select_library.htm">Peripheral Pin Select Library</a> is checked in the <a href="library_manager.htm">Library Manager</a>, and that appropriate pins were mapped.</li>
                </ul>
            </div>
            
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Example</th>
          <td valign="top">

<pre>
init = _CAN_CONFIG_SAMPLE_THRICE &#38;
       _CAN_CONFIG_PHSEG2_PRG_ON &#38;
       _CAN_CONFIG_STD_MSG       &#38;
       _CAN_CONFIG_DBL_BUFFER_ON &#38;
       _CAN_CONFIG_VALID_XTD_MSG &#38;
       _CAN_CONFIG_LINE_FILTER_OFF;
...
CANInitialize_Remappable(1, 1, 3, 3, 1, init);   <i>// initialize CAN</i></pre>

          </td>
        </tr>

      </tbody>

    </table>

    <!-- kraj tabele -->


    <!-- -->


    <h3 id="cansetbaudrate">CANSetBaudRate</h3>


    <!-- tabela: CANSetBaudRate -->

    <table class="routine" width="100%">

      <!--
      <caption></caption>

      <thead></thead>
      -->

      <tbody>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th width="0" valign="top">Prototype</th>
          <td class="code" width="100%" valign="top">
            <p><b>void</b> CANSetBaudRate(<b>char</b> SJW, <b>char</b> BRP, <b>char</b> PHSEG1, <b>char</b> PHSEG2, <b>char</b> PROPSEG, <b>char</b> CAN_CONFIG_FLAGS);</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Returns</th>
          <td valign="top">
            <p>Nothing.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Description</th>
          <td valign="top">
            <p>Sets <acronym title="Controller Area Network">CAN</acronym> baud rate. Due to complexity of <acronym title="Controller Area Network">CAN</acronym> protocol, you cannot simply force a bps value. Instead, use this function when <acronym title="Controller Area Network">CAN</acronym> is in Config mode. Refer to datasheet for details.</p>
            <p>Parameters:</p>
            <ul>
              <li><code>SJW</code> as defined in datasheet (1&#8211;4)</li>
              <li><code>BRP</code> as defined in datasheet (1&#8211;64)</li>
              <li><code>PHSEG1</code> as defined in datasheet (1&#8211;8)</li>
              <li><code>PHSEG2</code> as defined in datasheet (1&#8211;8)</li>
              <li><code>PROPSEG</code> as defined in datasheet (1&#8211;8)</li>
              <li><code>CAN_CONFIG_FLAGS</code> is formed from predefined constants (see <a href="#can_constants">CAN constants</a>)</li>
            </ul>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Requires</th>
          <td valign="top">
            <p><acronym title="Controller Area Network">CAN</acronym> must be in Config mode; otherwise the function will be ignored.</p>
            <p>Microcontroller must be connected to <acronym title="Controller Area Network">CAN</acronym> transceiver (MCP2551 or similar) which is connected to <acronym title="Controller Area Network">CAN</acronym> bus.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Example</th>
          <td valign="top">

<pre>
init = _CAN_CONFIG_SAMPLE_THRICE &#38;
       _CAN_CONFIG_PHSEG2_PRG_ON &#38;
       _CAN_CONFIG_STD_MSG       &#38;
       _CAN_CONFIG_DBL_BUFFER_ON &#38;
       _CAN_CONFIG_VALID_XTD_MSG &#38;
       _CAN_CONFIG_LINE_FILTER_OFF;
...
CANSetBaudRate(1, 1, 3, 3, 1, init);</pre>

          </td>
        </tr>

      </tbody>

    </table>

    <!-- kraj tabele -->


    <!-- -->


    <h3 id="cansetmask">CANSetMask</h3>


    <!-- tabela: CANSetMask -->

    <table class="routine" width="100%">

      <!--
      <caption></caption>

      <thead></thead>
      -->

      <tbody>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th width="0" valign="top">Prototype</th>
          <td class="code" width="100%" valign="top">
            <p><b>void</b> CANSetMask(<b>char</b> CAN_MASK, <b>long</b> value, <b>char</b> CAN_CONFIG_FLAGS);</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Returns</th>
          <td valign="top">
            <p>Nothing.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Description</th>
          <td valign="top">
            <p>Function sets mask for advanced filtering of messages. Given <code>value</code> is bit adjusted to appropriate buffer mask registers.</p>
            <p>Parameters:</p>
            <ul>
              <li><code>CAN_MASK</code> is one of predefined constant values (see <a href="#can_constants">CAN constants</a>)</li>
              <li><code>value</code> is the mask register value</li>
              <li><code>CAN_CONFIG_FLAGS</code> selects type of message to filter, either <code>_CAN_CONFIG_XTD_MSG</code> or <code>_CAN_CONFIG_STD_MSG</code></li>
            </ul>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Requires</th>
          <td valign="top">
            <p><acronym title="Controller Area Network">CAN</acronym> must be in Config mode; otherwise the function will be ignored.</p>
            <p>Microcontroller must be connected to <acronym title="Controller Area Network">CAN</acronym> transceiver (MCP2551 or similar) which is connected to <acronym title="Controller Area Network">CAN</acronym> bus.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Example</th>
          <td valign="top">

<pre>
<i>// Set all mask bits to 1, i.e. all filtered bits are relevant:</i>
CANSetMask(_CAN_MASK_B1, -1, _CAN_CONFIG_XTD_MSG);

<i>// Note that -1 is just a cheaper way to write 0xFFFFFFFF.
   Complement will do the trick and fill it up with ones.</i>
</pre>

          </td>
        </tr>

      </tbody>

    </table>

    <!-- kraj tabele -->


    <!-- -->


    <h3 id="cansetfilter">CANSetFilter</h3>


    <!-- tabela: CANSetFilter -->

    <table class="routine" width="100%">

      <!--
      <caption></caption>

      <thead></thead>
      -->

      <tbody>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th width="0" valign="top">Prototype</th>
          <td class="code" width="100%" valign="top">
            <p><b>void</b> CANSetFilter(<b>char</b> CAN_FILTER, <b>long</b> value, <b>char</b> CAN_CONFIG_FLAGS);</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Returns</th>
          <td valign="top">
            <p>Nothing.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Description</th>
          <td valign="top">
            <p>Function sets message filter. Given <code>value</code> is bit adjusted to appropriate buffer mask registers.</p>
            <p>Parameters:</p>
            <ul>
              <li><code>CAN_FILTER</code> is one of predefined constant values (see <a href="#can_constants">CAN constants</a>)</li>
              <li><code>value</code> is the filter register value</li>
              <li><code>CAN_CONFIG_FLAGS</code> selects type of message to filter, either <code>_CAN_CONFIG_XTD_MSG</code> or <code>_CAN_CONFIG_STD_MSG</code></li>
            </ul>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Requires</th>
          <td valign="top">
            <p><acronym title="Controller Area Network">CAN</acronym> must be in Config mode; otherwise the function will be ignored.</p>
            <p>Microcontroller must be connected to <acronym title="Controller Area Network">CAN</acronym> transceiver (MCP2551 or similar) which is connected to <acronym title="Controller Area Network">CAN</acronym> bus.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Example</th>
          <td valign="top">

<pre>
<i>// Set id of filter B1_F1 to 3:</i>
CANSetFilter(_CAN_FILTER_B1_F1, 3, _CAN_CONFIG_XTD_MSG);</pre>

          </td>
        </tr>

      </tbody>

    </table>

    <!-- kraj tabele -->


    <!-- -->


    <h3 id="canread">CANRead</h3>


    <!-- tabela: CANRead -->

    <table class="routine" width="100%">

      <!--
      <caption></caption>

      <thead></thead>
      -->

      <tbody>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th width="0" valign="top">Prototype</th>
          <td class="code" width="100%" valign="top">
            <p><b>char</b> CANRead(<b>long</b> *id, <b>char</b> *data, <b>char</b> *datalen, <b>char</b> *CAN_RX_MSG_FLAGS);</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Returns</th>
          <td valign="top">
            <p>Message from receive buffer or zero if no message found.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Description</th>
          <td valign="top">
            <p>Function reads message from receive buffer. If at least one full receive buffer is found, it is extracted and returned. If none found, function returns zero.</p>
            <p>Parameters:</p>
            <ul>
              <li><code>id</code> is message identifier</li>
              <li><code>data</code> is an array of bytes up to 8 bytes in length</li>
              <li><code>datalen</code> is data length, from 1&#8211;8.</li>
              <li><code>CAN_RX_MSG_FLAGS</code> is value formed from constants (see <a href="#can_constants">CAN constants</a>)</li>
            </ul>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Requires</th>
          <td valign="top">
            <p><acronym title="Controller Area Network">CAN</acronym> must be in mode in which receiving is possible.</p>
            <p>Microcontroller must be connected to <acronym title="Controller Area Network">CAN</acronym> transceiver (MCP2551 or similar) which is connected to <acronym title="Controller Area Network">CAN</acronym> bus.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Example</th>
          <td valign="top">

<pre>
<b>char</b> rcv, rx, len, data[8];
<b>long</b> id;

<i>// ...</i>
rx = 0;
<i>// ...</i>
rcv = CANRead(id, data, len, rx);</pre>

          </td>
        </tr>

      </tbody>

    </table>

    <!-- kraj tabele -->


    <!-- -->


    <h3 id="canwrite">CANWrite</h3>


    <!-- tabela: CANWrite -->

    <table class="routine" width="100%">

      <!--
      <caption></caption>

      <thead></thead>
      -->

      <tbody>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th width="0" valign="top">Prototype</th>
          <td class="code" width="100%" valign="top">
            <p><b>unsigned short</b> CANWrite(<b>long</b> id, <b>char</b> *data, <b>char</b> datalen, <b>char</b> CAN_TX_MSG_FLAGS);</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Returns</th>
          <td valign="top">
            <p>Returns zero if message cannot be queued (buffer full).</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Description</th>
          <td valign="top">
            <p>If at least one empty transmit buffer is found, function sends message on queue for transmission. If buffer is full, function returns 0.</p>
            <p>Parameters:</p>
            <ul>
              <li><code>id</code> is CAN message identifier. Only 11 or 29 bits may be used depending on message type (standard or extended)</li>
              <li><code>data</code> is array of bytes up to 8 bytes in length</li>
              <li><code>datalen</code> is data length from 1&#8211;8</li>
              <li><code>CAN_TX_MSG_FLAGS</code> is value formed from constants (see <a href="#can_constants">CAN constants</a>)</li>
            </ul>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Requires</th>
          <td valign="top">
            <p><acronym title="Controller Area Network">CAN</acronym> must be in Normal mode.</p>
            <p>Microcontroller must be connected to <acronym title="Controller Area Network">CAN</acronym> transceiver (MCP2551 or similar) which is connected to <acronym title="Controller Area Network">CAN</acronym> bus.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Example</th>
          <td valign="top">

<pre>
<b>char</b> tx, data;
<b>long</b> id;

<i>// ...</i>
tx = _CAN_TX_PRIORITY_0 &#38;
     _CAN_TX_XTD_FRAME;
<i>// ...</i>
CANWrite(id, data, 2, tx);</pre>

          </td>
        </tr>

      </tbody>

    </table>

    <!-- kraj tabele -->


    <!-- -->


    <h3 id="cansettxidlelevel">CANSetTxIdleLevel</h3>


    <!-- tabela: CANWrite -->

    <table class="routine" width="100%">

      <!--
      <caption></caption>

      <thead></thead>
      -->

      <tbody>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th width="0" valign="top">Prototype</th>
          <td class="code" width="100%" valign="top">
            <p><b>void</b> CANSetTxIdleLevel(<b>char</b> driveHighState);</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Returns</th>
          <td valign="top">
            <p>Nothing.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Description</th>
          <td valign="top">
            <p>This function sets the state of CANTX pin when recessive.</p>
            <p>Parameters:</p>
            <ul>
              <li><code>driveHighState:</code> State of the CANTX pin. Valid values :
                <table>
                  <tr align="center">
										<td bgcolor=#f5f2ec><b>Description</b></td>
										<td bgcolor=#f5f2ec><b>Predefined library const</b></td>
                  </tr>

                  <tr align="center">
										<td>CANTX pin will drive VDD when recessive. 
										<br>Use it when using a differential bus to avoid signal crosstalk in CANTX from other nearby pins.</td>
										<td><code>_CAN_DRIVE_HIGH_STATE_ENABLE</code></td>
                  </tr>
                  <tr align="center">
										<td>CANTX pin will be tri-state when recessive.</td>
										<td><code>_CAN_DRIVE_HIGH_STATE_DISABLE</code></td>
                  </tr>
                </table>
              </li>
            </ul>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Requires</th>
          <td valign="top">
            <p>Microcontroller must be connected to <acronym title="Controller Area Network">CAN</acronym> transceiver (MCP2551 or similar) which is connected to <acronym title="Controller Area Network">CAN</acronym> bus.</p>
          </td>
        </tr>

        <tr style="background:'white'" onmouseover="this.style.background='#f8f8f8';" onmouseout="this.style.background='white';">
          <th valign="top">Example</th>
          <td valign="top">

<pre>
CANSetTxIdleLevel(_CAN_DRIVE_HIGH_STATE_ENABLE);
</pre>

          </td>
        </tr>

      </tbody>

    </table>

    <!-- kraj tabele -->


    <!-- -->


    <h3 id="can_constants"><acronym title="Controller Area Network">CAN</acronym> Constants</h3>

    <p>There is a number of constants predefined in <acronym title="Controller Area Network">CAN</acronym> library. To be able to use the library effectively, you need to be familiar with these. You might want to check the example at the end of the chapter.</p>

    <h4>CAN_OP_MODE</h4>

    <p><code>CAN_OP_MODE</code> constants define <acronym title="Controller Area Network">CAN</acronym> operation mode. Function <code>CANSetOperationMode</code> expects one of these as its argument:</p>

<pre>
<b>const char</b>
    _CAN_MODE_BITS   = 0xE0,   <i>// Use this to access opmode  bits</i>
    _CAN_MODE_NORMAL = 0x00,
    _CAN_MODE_SLEEP  = 0x20,
    _CAN_MODE_LOOP   = 0x40,
    _CAN_MODE_LISTEN = 0x60,
    _CAN_MODE_CONFIG = 0x80;</pre>


    <h4><br>CAN_CONFIG_FLAGS</h4>

    <p><code>CAN_CONFIG_FLAGS</code> constants define flags related to <acronym title="Controller Area Network">CAN</acronym> module configuration. Functions <code>CANInitialize</code> and <code>CANSetBaudRate</code> expect one of these (or a bitwise combination) as their argument:</p>

<pre>
<b>const char</b>
    _CAN_CONFIG_DEFAULT         = 0xFF,   <i>// 11111111</i>

    _CAN_CONFIG_PHSEG2_PRG_BIT  = 0x01,
    _CAN_CONFIG_PHSEG2_PRG_ON   = 0xFF,   <i>// XXXXXXX1</i>
    _CAN_CONFIG_PHSEG2_PRG_OFF  = 0xFE,   <i>// XXXXXXX0</i>

    _CAN_CONFIG_LINE_FILTER_BIT = 0x02,
    _CAN_CONFIG_LINE_FILTER_ON  = 0xFF,   <i>// XXXXXX1X</i>
    _CAN_CONFIG_LINE_FILTER_OFF = 0xFD,   <i>// XXXXXX0X</i>

    _CAN_CONFIG_SAMPLE_BIT      = 0x04,
    _CAN_CONFIG_SAMPLE_ONCE     = 0xFF,   <i>// XXXXX1XX</i>
    _CAN_CONFIG_SAMPLE_THRICE   = 0xFB,   <i>// XXXXX0XX</i>

    _CAN_CONFIG_MSG_TYPE_BIT    = 0x08,
    _CAN_CONFIG_STD_MSG         = 0xFF,   <i>// XXXX1XXX</i>
    _CAN_CONFIG_XTD_MSG         = 0xF7,   <i>// XXXX0XXX</i>

    _CAN_CONFIG_DBL_BUFFER_BIT  = 0x10,
    _CAN_CONFIG_DBL_BUFFER_ON   = 0xFF,   <i>// XXX1XXXX</i>
    _CAN_CONFIG_DBL_BUFFER_OFF  = 0xEF,   <i>// XXX0XXXX</i>

    _CAN_CONFIG_MSG_BITS        = 0x60,
    _CAN_CONFIG_ALL_MSG         = 0xFF,   <i>// X11XXXXX</i>
    _CAN_CONFIG_VALID_XTD_MSG   = 0xDF,   <i>// X10XXXXX</i>
    _CAN_CONFIG_VALID_STD_MSG   = 0xBF,   <i>// X01XXXXX</i>
    _CAN_CONFIG_ALL_VALID_MSG   = 0x9F;   <i>// X00XXXXX</i></pre>

    <p>You may use bitwise AND (<code>&#38;</code>) to form config byte out of these values. For example:</p>

<div class="example">
  <textarea style="display:none;"></textarea> 
  <span class="copytoclipboard"><a onclick="copyToClipboard(this); return false;" href="#"><img align="absmiddle" alt="Copy Code To Clipboard" src="img/copy_to_clipboard.png" border="0" /><span class="clipboard_text">Copy Code To Clipboard</span></a></span>
</div>

<pre class="program">
init = _CAN_CONFIG_SAMPLE_THRICE &#38;
       _CAN_CONFIG_PHSEG2_PRG_ON &#38;
       _CAN_CONFIG_STD_MSG       &#38;
       _CAN_CONFIG_DBL_BUFFER_ON &#38;
       _CAN_CONFIG_VALID_XTD_MSG &#38;
       _CAN_CONFIG_LINE_FILTER_OFF;
...
CANInitialize(1, 1, 3, 3, 1, init);   <i>// initialize CAN</i></pre>


    <h4>CAN_TX_MSG_FLAGS</h4>

    <p><code>CAN_TX_MSG_FLAGS</code> are flags related to transmission of a <acronym title="Controller Area Network">CAN</acronym> message:</p>

<pre>
<b>const char</b>
    _CAN_TX_PRIORITY_BITS = 0x03,
    _CAN_TX_PRIORITY_0    = 0xFC,   <i>// XXXXXX00</i>
    _CAN_TX_PRIORITY_1    = 0xFD,   <i>// XXXXXX01</i>
    _CAN_TX_PRIORITY_2    = 0xFE,   <i>// XXXXXX10</i>
    _CAN_TX_PRIORITY_3    = 0xFF,   <i>// XXXXXX11</i>

    _CAN_TX_FRAME_BIT    = 0x08,
    _CAN_TX_STD_FRAME    = 0xFF,   <i>// XXXXX1XX</i>
    _CAN_TX_XTD_FRAME    = 0xF7,   <i>// XXXXX0XX</i>

    _CAN_TX_RTR_BIT      = 0x40,
    _CAN_TX_NO_RTR_FRAME = 0xFF,   <i>// X1XXXXXX</i>
    _CAN_TX_RTR_FRAME    = 0xBF;    <i>// X0XXXXXX</i></pre>

    <p>You may use bitwise AND (<code>&#38;</code>) to adjust the appropriate flags. For example:</p>

<div class="example">
  <textarea style="display:none;"></textarea> 
  <span class="copytoclipboard"><a onclick="copyToClipboard(this); return false;" href="#"><img align="absmiddle" alt="Copy Code To Clipboard" src="img/copy_to_clipboard.png" border="0" /><span class="clipboard_text">Copy Code To Clipboard</span></a></span>
</div>

<pre class="program">
<i>// form value to be used with CANSendMessage:</i>
send_config = _CAN_TX_PRIORITY_0 &#38;
              _CAN_TX_XTD_FRAME  &#38;
              _CAN_TX_NO_RTR_FRAME;
...
CANSendMessage(id, data, 1, send_config);</pre>

    <h4>CAN_RX_MSG_FLAGS</h4>

    <p><code>CAN_RX_MSG_FLAGS</code> are flags related to reception of <acronym title="Controller Area Network">CAN</acronym> message. If a particular bit is set; corresponding meaning is TRUE or else it will be FALSE.</p>

<pre>
<b>const char</b>
    _CAN_RX_FILTER_BITS  = 0x07,  <i>// Use this to access filter bits</i>
    _CAN_RX_FILTER_1     = 0x00,
    _CAN_RX_FILTER_2     = 0x01,
    _CAN_RX_FILTER_3     = 0x02,
    _CAN_RX_FILTER_4     = 0x03,
    _CAN_RX_FILTER_5     = 0x04,
    _CAN_RX_FILTER_6     = 0x05,
    _CAN_RX_OVERFLOW     = 0x08,  <i>// Set if Overflowed else cleared</i>
    _CAN_RX_INVALID_MSG  = 0x10,  <i>// Set if invalid else cleared</i>
    _CAN_RX_XTD_FRAME    = 0x20,  <i>// Set if XTD message else cleared</i>
    _CAN_RX_RTR_FRAME    = 0x40,  <i>// Set if RTR message else cleared</i>
    _CAN_RX_DBL_BUFFERED = 0x80;  <i>// Set if this message was hardware double-buffered</i>
</pre>
    <p>You may use bitwise AND (<code>&#38;</code>) to adjust the appropriate flags. For example:</p>

<div class="example">
  <textarea style="display:none;"></textarea> 
  <span class="copytoclipboard"><a onclick="copyToClipboard(this); return false;" href="#"><img align="absmiddle" alt="Copy Code To Clipboard" src="img/copy_to_clipboard.png" border="0" /><span class="clipboard_text">Copy Code To Clipboard</span></a></span>
</div>

<pre class="program">
<b>if</b> (MsgFlag &#38; _CAN_RX_OVERFLOW != 0) {
  ...
  <i>// Receiver overflow has occurred.
  // We have lost our previous message.</i>
}</pre>

    <h4>CAN_MASK</h4>

    <p><code>CAN_MASK</code> constants define mask codes. Function <code>CANSetMask</code> expects one of these as its argument:</p>

<pre>
#<b>const char</b>
    _CAN_MASK_B1 = 0,
    _CAN_MASK_B2 = 1;</pre>


    <h4><br>CAN_FILTER</h4>

    <p><code>CAN_FILTER</code> constants define filter codes. Function <code>CANSetFilter</code> expects one of these as its argument:</p>

<pre>
<b>const char</b>
    _CAN_FILTER_B1_F1 = 0,
    _CAN_FILTER_B1_F2 = 1,
    _CAN_FILTER_B2_F1 = 2,
    _CAN_FILTER_B2_F2 = 3,
    _CAN_FILTER_B2_F3 = 4,
    _CAN_FILTER_B2_F4 = 5;</pre>


    <!-- -->

		<h3>Library Example</h3>

    <p>This is a simple demonstration of <acronym title="Controller Area Network">CAN</acronym> Library routines usage.
    	 First node initiates the communication with the second node by sending some data to its address. The second node responds by sending back the data 
    	 incremented by 1. First node then does the same and sends incremented data back to second node, etc.</p>
    <p>Code for the first CAN node:</p>

<div class="example">
  <textarea style="display:none;"></textarea> 
  <span class="copytoclipboard"><a onclick="copyToClipboard(this); return false;" href="#"><img align="absmiddle" alt="Copy Code To Clipboard" src="img/copy_to_clipboard.png" border="0" /><span class="clipboard_text">Copy Code To Clipboard</span></a></span>
</div>

<pre class="program">
<b>unsigned char</b> Can_Init_Flags, Can_Send_Flags, Can_Rcv_Flags; <i>// can flags</i>
<b>unsigned char</b> Rx_Data_Len;                                   <i>// received data length in bytes</i>
<b>char</b> RxTx_Data[8];                                           <i>// can rx/tx data buffer</i>
<b>char</b> Msg_Rcvd;                                               <i>// reception flag</i>
<b>const long</b> ID_1st = 12111, ID_2nd = 3;                       <i>// node IDs</i>
<b>long</b> Rx_ID;

<b>void</b> main() {

  PORTC = 0;                                                <i>// clear PORTC</i>
  TRISC = 0;                                                <i>// set PORTC as output</i>

  Can_Init_Flags = 0;                                       <i>//</i>
  Can_Send_Flags = 0;                                       <i>// clear flags</i>
  Can_Rcv_Flags  = 0;                                       <i>//</i>

  Can_Send_Flags = _CAN_TX_PRIORITY_0 &#38;                     <i>// form value to be used</i>
                   _CAN_TX_XTD_FRAME &#38;                      <i>//     with CANWrite</i>
                   _CAN_TX_NO_RTR_FRAME;

  Can_Init_Flags = _CAN_CONFIG_SAMPLE_THRICE &#38;              <i>// form value to be used</i>
                   _CAN_CONFIG_PHSEG2_PRG_ON &#38;              <i>// with CANInit</i>
                   _CAN_CONFIG_XTD_MSG &#38;
                   _CAN_CONFIG_DBL_BUFFER_ON &#38;
                   _CAN_CONFIG_VALID_XTD_MSG;
  
  CANInitialize(1,3,3,3,1,Can_Init_Flags);                  <i>// Initialize CAN module</i>
  CANSetOperationMode(_CAN_MODE_CONFIG,0xFF);               <i>// set CONFIGURATION mode</i>
  CANSetMask(_CAN_MASK_B1,-1,_CAN_CONFIG_XTD_MSG);          <i>// set all mask1 bits to ones</i>
  CANSetMask(_CAN_MASK_B2,-1,_CAN_CONFIG_XTD_MSG);          <i>// set all mask2 bits to ones</i>
  CANSetFilter(_CAN_FILTER_B2_F4,ID_2nd,_CAN_CONFIG_XTD_MSG);<i>// set id of filter B2_F4 to 2nd node ID</i>

  CANSetOperationMode(_CAN_MODE_NORMAL,0xFF);               <i>// set NORMAL mode</i>

  RxTx_Data[0] = 9;                                         <i>// set initial data to be sent</i>

  CANWrite(ID_1st, RxTx_Data, 1, Can_Send_Flags);           <i>// send initial message</i>

  <b>while</b>(1) {                                                               <i>// endless loop</i>
    Msg_Rcvd = CANRead(&#38;Rx_ID , RxTx_Data , &#38;Rx_Data_Len, &#38;Can_Rcv_Flags); <i>// receive message</i>
    <b>if</b> ((Rx_ID == ID_2nd) &#38;&#38; Msg_Rcvd) {                                   <i>// if message received check id</i>
      PORTC = RxTx_Data[0];                                                <i>// id correct, output data at PORTC</i>
      RxTx_Data[0]++ ;                                                     <i>// increment received data</i>
      Delay_ms(10);
      CANWrite(ID_1st, RxTx_Data, 1, Can_Send_Flags);                      <i>// send incremented data back</i>
    }
  }
}
</pre>		

    <p>Code for the second CAN node:</p>

<div class="example">
  <textarea style="display:none;"></textarea> 
  <span class="copytoclipboard"><a onclick="copyToClipboard(this); return false;" href="#"><img align="absmiddle" alt="Copy Code To Clipboard" src="img/copy_to_clipboard.png" border="0" /><span class="clipboard_text">Copy Code To Clipboard</span></a></span>
</div>

<pre class="program">
<b>unsigned char</b> Can_Init_Flags, Can_Send_Flags, Can_Rcv_Flags; <i>// can flags</i>
<b>unsigned char</b> Rx_Data_Len;                                   <i>// received data length in bytes</i>
<b>char</b> RxTx_Data[8];                                           <i>// can rx/tx data buffer</i>
<b>char</b> Msg_Rcvd;                                               <i>// reception flag</i>
<b>const long</b> ID_1st = 12111, ID_2nd = 3;                       <i>// node IDs</i>
<b>long</b> Rx_ID;

<b>void</b> main() {

  PORTC = 0;                                                <i>// clear PORTC</i>
  TRISC = 0;                                                <i>// set PORTC as output</i>

  Can_Init_Flags = 0;                                       <i>//</i>
  Can_Send_Flags = 0;                                       <i>// clear flags</i>
  Can_Rcv_Flags  = 0;                                       <i>//</i>

  Can_Send_Flags = _CAN_TX_PRIORITY_0 &#38;                     <i>// form value to be used</i>
                   _CAN_TX_XTD_FRAME &#38;                      <i>//     with CANWrite</i>
                   _CAN_TX_NO_RTR_FRAME;

  Can_Init_Flags = _CAN_CONFIG_SAMPLE_THRICE &#38;              <i>// form value to be used</i>
                   _CAN_CONFIG_PHSEG2_PRG_ON &#38;              <i>// with CANInit</i>
                   _CAN_CONFIG_XTD_MSG &#38;
                   _CAN_CONFIG_DBL_BUFFER_ON &#38;
                   _CAN_CONFIG_VALID_XTD_MSG &#38;
                   _CAN_CONFIG_LINE_FILTER_OFF;

  CANInitialize(1,3,3,3,1,Can_Init_Flags);                  <i>// initialize external CAN module</i>
  CANSetOperationMode(_CAN_MODE_CONFIG,0xFF);               <i>// set CONFIGURATION mode</i>
  CANSetMask(_CAN_MASK_B1,-1,_CAN_CONFIG_XTD_MSG);          <i>// set all mask1 bits to ones</i>
  CANSetMask(_CAN_MASK_B2,-1,_CAN_CONFIG_XTD_MSG);          <i>// set all mask2 bits to ones</i>
  CANSetFilter(_CAN_FILTER_B2_F3,ID_1st,_CAN_CONFIG_XTD_MSG);<i>// set id of filter B2_F3 to 1st node ID</i>

  CANSetOperationMode(_CAN_MODE_NORMAL,0xFF);               <i>// set NORMAL mode</i>

  <b>while</b> (1) {                                                              <i>// endless loop</i>
    Msg_Rcvd = CANRead(&#38;Rx_ID , RxTx_Data , &#38;Rx_Data_Len, &#38;Can_Rcv_Flags); <i>// receive message</i>
    <b>if</b> ((Rx_ID == ID_1st) &#38;&#38; Msg_Rcvd) {                                   <i>// if message received check id</i>
      PORTC = RxTx_Data[0];                                                <i>// id correct, output data at PORTC</i>
      RxTx_Data[0]++ ;                                                     <i>// increment received data</i>
      CANWrite(ID_2nd, RxTx_Data, 1, Can_Send_Flags);                      <i>// send incremented data back</i>
    }
  }
}
</pre>	
	
		<!-- -->


    <h3>HW Connection</h3>

    <p class="center"><img alt="Example of interfacing CAN transceiver with MCU and bus" src="img/schemes/scheme_can.gif"></p>
    <p class="center small">Example of interfacing CAN transceiver with MCU and bus</p>


      <div class="feedback">
      Copyright (c) 2002-2019 mikroElektronika. All rights reserved.
      <br>What do you think about this topic ?  <a href="https://helpdesk.mikroe.com/conversation/new/3" target="_blank">Send us feedback!</a>
    </div>

    <div class="libstock">Want more examples and libraries?&nbsp;
     <br>Find them on
     <a href="http://www.libstock.com/" target="_blank"><img alt="LibStock - A place for the code" src="img/libstock.gif" border="0" align="absmiddle"></a>
    </div>

  </div><!--/main-->




</body>

</html>
